# Ubuntu Apport TOCTOU (CVE-2019-7307) and whoopsie heap buffer overflow (CVE-2019-11476)

This directory contains proof-of-concept exploits for vulnerabilities in Ubuntu's crash reporting system:

* [CVE-2019-7307](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-7307) is a time-of-check to time-of-use (TOCTOU) vulnerability in Apport, which enables an unprivileged local user to trick Apport into including the contents of an arbitrary file in a crash report. The full bug report is public on [bugs.launchpad.net](https://bugs.launchpad.net/ubuntu/+source/apport/+bug/1830858).
* [CVE-2019-11476](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-11476) is a denial of service vulnerability. An integer overflow when reading large crash dumps (> 4GB) leads to a heap buffer overflow. I do not believe it is possible to exploit this heap buffer overflow to achieve code execution, so I have classified this bug as a denial of service. The full bug report is public on [bugs.launchpad.net](https://bugs.launchpad.net/ubuntu/+source/whoopsie/+bug/1830863).

## Instructions

I usually try to provide a `Dockerfile` so that my PoCs are safely reproducible on a patched system. Unfortunately, Apport is specifically designed to behave differently inside a container, so I am not able to do so this time. Instead, if you would like to test the exploit, then you will need to revert the bug fix in your Apport installation. You can do that as follows:

```
git clone https://git.launchpad.net/ubuntu/+source/apport
cd apport
git checkout applied/2.20.9-0ubuntu7.6
sudo cp apport/report.py /usr/lib/python3/dist-packages/apport/report.py
```

When you are done, don't forget to fix your installation:

```
sudo apt-get install --reinstall python3-apport
```

Build the PoC for Apport CVE-2019-7307 like this:

```
make
```

And run it like this:

```
./gencrashreport /etc/shadow
```

This will create a file named `/var/crash/_usr_share_apport_apport.0.crash`, which is owned by `root`, but also readable by `whoopsie`. For a full exploit chain, we would therefore also need a second exploit that enables us to read files as whoopsie. But since we don't have that yet, we need to change the permissions of the crash report:

```
sudo chmod 666 /var/crash/_usr_share_apport_apport.0.crash
```

At this point, you can unpack the crash report and see that the contents of `/etc/shadow` are embedded in the `CoreDump` file:

```
mkdir report
apport-unpack /var/crash/_usr_share_apport_apport.0.crash report
cd report
```

Note: `apport-unpack` is a bit flaky and usually crashes with an error message like this: `['ProcEnviron', 'UserGroups'] has no binary content`. But it works well enough to extract the core dump from the report. Now use your favorite text editor to open `CoreDump` and search for the contents of `/etc/password`. Searching for the string "root:" usually works.
