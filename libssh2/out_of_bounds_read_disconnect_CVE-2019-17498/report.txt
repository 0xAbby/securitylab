Dear libssh2 security team,

I would like to report a security vulnerability in libssh2. The problem is a negative integer overflow in the comparison at this source location:

https://github.com/libssh2/libssh2/blob/42d37aa63129a1b2644bf6495198923534322d64/src/packet.c#L480

The value of datalen is untrusted because it came from the remote computer. If datalen == 11, for example, then the subtraction will overflow and the bounds-check of message_len is ineffective, leading to an out-of-bounds read on line 485.

There are other similar-looking cases elsewhere in the code. I would recommend that you have a look at this list, some of which look to me like they could be variants of the same bug:

https://lgtm.com/query/8983141241038526104/

I have attached a small binary file, which you can use to reproduce the bug. Use it like this to simulate a malicious SSH server:

sudo nc -l -p 22 < poc.bin

Then run libssh2 like this:

cd ~/libssh2/example
./ssh localhost
Please let me know when you have fixed the bugs, so that I can coordinate my disclosure with yours. For reference, here is a link to Semmle's vulnerability disclosure policy: https://lgtm.com/security

Thank you,

Kevin Backhouse

Semmle Security Research Team
